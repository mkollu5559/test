import pytest
from unittest.mock import patch
from aws.lambda.s3notification import lambda as lambda_module

@pytest.fixture
def s3_event():
    return {
        "Records": [{
            "eventTime": "2024-03-19T12:00:00Z",
            "s3": {
                "bucket": {"name": "test-bucket"},
                "object": {"key": "test-file.txt", "size": 12345}
            }
        }]
    }

@patch.dict("aws.lambda.s3notification.lambda.os.environ", {
    "TOPIC_ARN": "arn:aws:sns:us-east-1:123456789012:MyTopic"
})
@patch("aws.lambda.s3notification.lambda.handle_publish_sns")
def test_lambda_handler(mock_publish, s3_event):
    mock_publish.return_value = {"MessageId": "mock-message-id"}

    response = lambda_module.lambda_handler(s3_event, None)
    print(f"DEBUG: Lambda Handler Response: {response}")

    assert response is not None, "lambda_handler returned None"
    assert "MessageId" in response
    assert response["MessageId"] == "mock-message-id"
    mock_publish.assert_called_once()
