import sys
import os
import pytest
import boto3
from moto import mock_aws
from datetime import datetime

# Add module path
sys.path.append(os.path.abspath("module/aws/lambda_functions/maa_ma_datasync_data_registration"))

from lambda_function import get_s3_notification, audit_table_insert


@pytest.fixture
@mock_aws
def s3_setup():
    s3 = boto3.client('s3', region_name='us-east-1')
    bucket_name = 'test-bucket'
    s3.create_bucket(Bucket=bucket_name)

    s3.put_bucket_notification_configuration(
        Bucket=bucket_name,
        NotificationConfiguration={
            'QueueConfigurations': [
                {
                    'QueueArn': 'arn:aws:sqs:us-east-1:123456789012:test-queue',
                    'Events': ['s3:ObjectCreated:*']
                }
            ]
        }
    )
    yield bucket_name


@mock_aws
def test_get_s3_notification(s3_setup):
    bucket = s3_setup
    result = get_s3_notification(bucket)
    assert 'QueueConfigurations' in result
    assert result['QueueConfigurations'][0]['QueueArn'] == 'arn:aws:sqs:us-east-1:123456789012:test-queue'


@mock_aws
def test_audit_table_insert(monkeypatch):
    dynamodb = boto3.resource('dynamodb', region_name='us-east-1')
    table_name = 'maa-ma-datasync-file-copy-audit-hist'

    table = dynamodb.create_table(
        TableName=table_name,
        KeySchema=[{'AttributeName': 'Run_ID', 'KeyType': 'HASH'}],
        AttributeDefinitions=[{'AttributeName': 'Run_ID', 'AttributeType': 'S'}],
        BillingMode='PAY_PER_REQUEST'
    )

    import lambda_function
    lambda_function.audit_table = table

    lambda_function.audit_table_insert(
        JobRunId='test-123',
        LOB='finance',
        source_db='maindb',
        source_table='transactions',
        glue_job_name='glue-job-test'
    )

    response = table.get_item(Key={'Run_ID': 'test-123'})
    item = response['Item']

    assert item['Glue_Job_Name'] == 'glue-job-test'
    assert item['LOB'] == 'finance'
    assert item['TDV_Table_Name'] == 'maindb.transactions'
    assert item['Run_Status'] == 'Started'
